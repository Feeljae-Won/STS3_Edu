<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.zerock.air.mapper.AirMapper">

	<!-- id 는 메소드 이름과 같아야 한다. -->
	<select id="searchList" resultType="org.zerock.air.vo.AirVO">
	    select 
	        a.countryCode, a.airportCode, a.airportEng, a.airportKor, c.countryKor, c.countryEng, c.pan
	    from
	        airport a, country c
	    where
	        a.countryCode = c.countryCode
	        and
	        (
	            a.airportCode like '%' || #{searchAirport} || '%'
	            or a.airportKor like '%' || #{searchAirport} || '%'
	            or a.airportEng like '%' || #{searchAirport} || '%'
	            or c.countryKor like '%' || #{searchAirport} || '%'
	            or c.countryEng like '%' || #{searchAirport} || '%'
	        )
	</select>
	
	<!-- 항공권 검색 결과 -->
	<select id="searchResult" resultType="org.zerock.air.vo.AirVO">
		SELECT 
		    m.photo, 
		    al.airlineKor, 
		    ar.departure, 
		    dep_airport.airportKor AS departureKor, 
		    ar.arrival, 
		    arr_airport.airportKor AS arrivalKor, 
		    ash.duration, 
		    ash.ScheduleId, 
		    ash.status, 
		    TO_CHAR(ash.departureTime, 'hh24:mm') AS departureTime, 
		    TO_CHAR(ash.arrivalTime, 'hh24:mm') AS arrivalTime, 
		    (SELECT SUM(basePrice + tax + fuelSurCharge + bookingFee) 
		     FROM airPrice 
		     WHERE routeId = 1) AS totalPrice 
		FROM 
		    member m 
		JOIN 
		    airline al ON m.id = al.id 
		JOIN 
		    airSchedule ash ON al.airlineNo = ash.airlineNo 
		JOIN 
		    airRoute ar ON ar.routeId = ash.routeID 
		JOIN 
		    airport dep_airport ON dep_airport.airportCode = ar.departure 
		JOIN 
		    airport arr_airport ON arr_airport.airportCode = ar.arrival 
		WHERE 
			(
		    ar.departure = #{departure} 
		    AND ar.arrival = #{arrival}
		    AND TRUNC(ash.departureTime) = #{departureTime}
		    )
		    <if test="#{arrivalTime} != null">
		    or
		    (
		    ar.departure = #{arrival} 
		    AND ar.arrival = #{departure}
		    AND TRUNC(ash.departureTime) = #{arrivalTime}
		    )
		    </if>
	</select>
	
</mapper>